{% extends "base.html" %}
{% load staticfiles %}
{% load avatar_tags %}
{% load embed_video_tags %}

{% load i18n %} 	#Esto es para la internacionalización
{% load bootstrap3 %}
{% block head_added %}
<link href="{% static "css/modal_avatar.css" %}" rel="stylesheet">
<link href="{% static "css/muro.css" %}" rel="stylesheet">
<link href="{% static "css/long_shadow.css" %}" rel="stylesheet">
<link href="{% static "css/icono_buscar.css" %}" rel="stylesheet">
{% endblock %}

{% url 'muro' argument %}

{% block content %}

<div class="muro">

  <div class="buscar">
    <form action="{% url 'busqueda' %}" method="get" id="content">
      <input type="text" name="s" class="input">
      <button type="reset" class="search"></button>
    </form>
    <a href=""><button class="btn" id="busqueda_a" type="submit">Búsqueda Avanzada</button></a>
  </div>

  <!--<a href="{% url 'avatar_change' %}" data-toggle="modal" data-target="#theModal">{% avatar user %}</a>-->

  <div class="cabecera_usuario">

    <div class="cabecera_interior">
      <div class="cabecera_nombre md-long-shadow">
        <h2><span> {{ user.username }}</span></h2>
        <h2>{{ user.first_name }} {{ user.last_name }}</h2>
      </div>
    </div>

    <a class="a_img_usuario" href="{% url 'avatar_change' %}" data-toggle="modal" data-target="#theModal"><img src="{% avatar_url user %}" class="img-circle img_usuario"></a>

    <div id="theModal" class="modal fade text-center">
      <div class="modal-dialog">
        <div class="modal-content">
        </div>
      </div>
    </div>

    <!--<hr class="hr_1">-->
    <div class="cabecera_descripcion">
      <h3>{{ user.profile.descripcion }}</h3>
    </div>
    
    <!-- <hr class="hr_2"> -->

    <div class="cabecera_deportes">
      {% for deporte in user.profile.deportes.all %}

      {{ deporte }}

      {% endfor %}
    </div>

  </div>

  <a href="{% url "crear_publicacion" %} "><button class="btn" id="crear_publi" type="submit">Crear Publicación</button></a>

  
  {% for publicacion in publicaciones %}
  <div class="row publicacion">
    <p class="fecha_hora">
      {{ publicacion.fecha_hora }}
    </p>
    <h2 class="titulo_publicacion">
      {{ publicacion.titulo }}
    </h2>
    <hr>
    <div class="interior_publicacion">

      {% video publicacion.video as my_video %}
      {% if my_video != '' %}
      <div class="embed-responsive embed-responsive-16by9 video_publicacion">
        {% video my_video %}
      </div>
      {% endif %}
      {% endvideo %}

      {% if publicacion.imagen.url != '' %}
      <img src="{{ publicacion.imagen.url }}" alt="..." class="img-thumbnail center-block imagen_publicacion">
      {% endif %}
    </div>
    <hr>
    <p class="texto_publicacion">
      {{ publicacion.texto }}
    </p>
    <hr>
    <!-- <a href="{% url 'eliminar_publicacion' publicacion.id %}"<li>Eliminar publicación {{ publicacion.id }}</li></a> -->
    <div class="pie_publicacion">

    <a  class="borrar_publicacion" data-toggle="modal" data-target="#modal_borrar_publi" data-id-publi="{{ publicacion.id }}" title="Borrar" href="#?">
        <i class="fa fa-trash"></i>
      </a>

      <a href="{% url 'editar_publicacion' publicacion.id %}" title="Editar"><i class="fa fa-pencil"></i></a>

    </div>
    {% if publicacion.comments.all.count > 0 %}
      <a class="enlace_mostrar_ocultar" href="#?">Mostrar comentarios &#9660;</a>

      <div class="div_comentarios" style="display: none">
      <!-- Usamos ya la publicación obtenida en el for padre -->
      {% for comentario in publicacion.comments.all %} 
      <hr class="hr_comentario">
      <img src="{% avatar_url comentario.autor %}" class="img-circle">
      <p class="autor_comentario"><b>{{ comentario.autor.first_name }} {{ comentario.autor.last_name }}</b></p>
      <p class="texto_comentario">{{ comentario.texto }}</p>
      <p class="fecha_comentario">{{ comentario.fecha_hora }}</p><br>
      {% endfor %}
    </div>
    {% endif %}

    <!-- Modal -->
    <div class="modal fade" id="modal_borrar_publi" tabindex="-1" role="dialog" aria-labelledby="modal_borrar_publiLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="modal_borrar_publiLabel">{% trans "Are you sure that you want to delete this news?" %}</h4>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Close" %}</button>
            <button id="borrarPublicacionSubmit" type="button" class="btn btn-primary">{% trans "Delete" %}</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  {% endfor %}

<!--
  <div class="row paginacion">
   <ul class="pagination pagination-sm">

     {% if publicaciones.has_previous %}   
     <li><a href="?page={{ publicaciones.previous_page_number }}">&laquo;</a></li>  
     {% else %}
     <li class="disabled">
      <span>&laquo;</span>
    </li>  
    {% endif %}       

    {% for i in publicaciones.paginator.page_range  %}

    <li><a href="?page={{ i }}">{{ i }}</a></li>

    {% endfor %}

    {% if publicaciones.has_next %}   
    <li><a href="?page={{ publicaciones.next_page_number }}">&raquo;</a></li>
    {% else %}   
    <li class="disabled">
      <span>&raquo;</span>
    </li>
    {% endif %}

  </ul>
</div> -->

<a href="#" class="back-to-top"><div class="subir"><i class="fa fa-chevron-up"></i></div></a>

</div>

<!-- Esto es para la ventana modal de desea borrar -->
<script type="text/javascript">
  (function($){   //El jQuery se puede sustituir por $
    $(document).ready(function () {
      $("#borrarPublicacionSubmit").click(function(){
        $.ajax("",
          {method: 'post',
          data: {csrfmiddlewaretoken: "{{ csrf_token }}"},
           //data: {csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()},
           success: function(){
            window.location.href = "{% url "muro" %}";
          }}); 
      });
    });
  })(jQuery);
</script>

<script type="text/javascript">
  $('#modal_borrar_publi').on('show.bs.modal', function(event){
    var button = $(event.relatedTarget);
    var id = button.data('id-publi');
    $("#borrarPublicacionSubmit").click(function(){
      $.ajax("/eliminar_publicacion/" + id + "/",
        {method: 'post',
        data: {csrfmiddlewaretoken: "{{ csrf_token }}"},
           //data: {csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val()},
           success: function(){
            window.location.href = "{% url "muro" %}";
          }}); 
    });
  })

</script>

<!-- Esto es para el buscador -->
<script type="text/javascript">
  function expand() {
    $(".search").toggleClass("close");
    $(".input").toggleClass("square");
    if ($('.search').hasClass('close')) {
      $('.input').focus();
    } else {
      $('.input').blur();
    }
  }
  $('button').on('click', expand);
</script>

<!-- Esto es para subir -->
<script type="text/javascript">
  jQuery(document).ready(function() {
    var offset = 220;
    var duration = 500;
    jQuery(window).scroll(function() {
      if (jQuery(this).scrollTop() > offset) {
        jQuery('.back-to-top').fadeIn(duration);
      } else {
        jQuery('.back-to-top').fadeOut(duration);
      }
    });
    
    jQuery('.back-to-top').click(function(event) {
      event.preventDefault();
      jQuery('html, body').animate({scrollTop: 0}, duration);
      return false;
    })
  });
</script>

<!-- Div comentarios -->
<script language="javascript">

$(".enlace_mostrar_ocultar").on('click', mostrar_comentarios);

function mostrar_comentarios(evento) {
  evento.preventDefault();
  $enlace_mostrar_ocultar = $(evento.target);
  $div_comentarios  = $enlace_mostrar_ocultar.next()

  console.log($enlace_mostrar_ocultar);
  console.log($div_comentarios);
      if($div_comentarios.css('display') == "block") {
      $div_comentarios.css('display', 'none');
      $enlace_mostrar_ocultar.html("Mostrar comentarios &#9660;");
    }
    else {
      $div_comentarios.css('display', 'block');
      $enlace_mostrar_ocultar.html("Ocultar comentarios &#9650;");
    }
} 
</script>

{% endblock %}